---
title: "gilmore-thomas-fesi.Rmd"
author: "rogilmore"
date: "`r Sys.time()`"
output: html_document
params:
  group: child
  harmonic: 1F1
  p_thresh: .0005
  dpi: 72
  plot_dev: png
  n_top: 9
  plot_titles: FALSE
---

## Analysis of `r params$group` group results at `r params$harmonic`

### Initialize

```{r set-up-paths, echo=FALSE, include=FALSE}
# Uncomment next line if running interactively
#params <- list(group="adult", harmonic="1F1", p_thresh=.0005, dpi=72, plot_dev="png", n_top=9, plot_titles=TRUE)

data_path <- 'csv/'
figs_path <- 'figs/'
R_path <- 'R/'

moco_fn <- paste("moco-3-pattern-", params$group, ".csv", sep="")
egi_fn <- "egi.csv"

moco_path <- paste(data_path, moco_fn, sep="")
egi_path <- paste(data_path, egi_fn, sep="")
topoplot_fullpath <- paste(figs_path, "topoplot.png", sep="")
```

```{r source-R-scripts, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
# Source R scripts.
file.sources <- list.files(path="R", pattern="*.R$", full.names = TRUE)
sapply(file.sources, source, .GlobalEnv)
```

```{r libraries, warning=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)
library(png)
library(gridExtra)
library(tidyr)
library(knitr)
library(DescTools)
library(heplots) # for etasq()
library(ez)
library(Cairo)

path2figs <- paste('figs', params$harmonic, params$group, "", sep="/")
knitr::opts_chunk$set(dpi=params$dpi, dev=params$plot_dev, fig.path=path2figs, fig.width = 8.5)
```

### Load dataframes

```{r load-data}
df_moco <- read.csv(moco_path)
df_egi <- read.csv(egi_path)
```

### T2Circ effects for `r params$harmonic` for `r init_cap(params$group)` participants

#### T2Circ across conditions

```{r figX-T2Circ-across-subjects-conds, echo=FALSE}
t2_circ_list <- lapply(unique(df_moco$Channel), compute_t2_circ_across_spd, df_moco, harm=params$harmonic, bysubject=FALSE)
df_t2cacr <- data.frame(Chan <- 1:128, matrix(unlist(t2_circ_list), nrow=128, byrow=T))
names(df_t2cacr) <- c('Chan', 'T2', 'Pvals', 'df1', 'df2') 
df_t2cacr$xpos <- df_egi$xpos
df_t2cacr$ypos <- df_egi$ypos

# Cut pvals
pvals_cuts <- c(-.01,.0001, .0005, .001, .005, .01, .05, 1)
pvals_lbls <- c("<.0001","<.0005", "<.001", "<.005", "<.01", "<.05", "ns")

# Create cuts based on p-value levels
Pvals_cuts <- cut( df_t2cacr$Pvals, breaks=pvals_cuts, labels=pvals_lbls)
Pvals_cuts <- ordered( Pvals_cuts, levels = rev( pvals_lbls ) )
df_t2cacr$Pvals_cuts <- Pvals_cuts

# Topo plot and table
plot_t2_channel_effects_across(df_t2cacr, harm=params$harmonic, group=params$group, "T2circ", topoplot_fullpath, plot_titles=params$plot_titles)

# Table of results to file
out.fn <- paste("csv/", params$group, "-", 
                  params$harmonic, 
                  "-T2Circ.csv", sep="")
write.csv(x = df_t2cacr, file = out.fn, row.names = FALSE)
```

#### T2Circ channels below criterion

```{r, echo=FALSE}
df_t2circ_below_thresh <- df_t2cacr %>%
  filter(Pvals <= as.numeric(params$p_thresh)) %>%
  arrange(Chan)

if (dim(df_t2circ_below_thresh)[1] > 0) kable(df_t2circ_below_thresh, caption="T2circ values across participants")
```

There are `r length(unique(df_t2circ_below_thresh$Chan))` channels below threshold.

### MANOVA

#### Effects for pattern and speed

```{r figX-channel-wise-effects}
form <- cbind(Sr, Si) ~ Pattern*Speed + Error(iSess)
chan_eff <- compute_chan_effects(df_moco, params$harmonic, form)
df_chan_stats <- make_stats_df(chan_eff, df_egi)
plot_channel_effects(df_chan_stats, harm=params$harmonic, group=params$group, topoplot_fullpath, plot_titles=params$plot_titles)
```

### Mean amplitude plots of `r params$harmonic` channels meeting `r paste('p< ', params$p_thresh, sep='')` for `r init_cap(params$group)` participants.

```{r figX-vector-amplitude-barplots-pattern}
plot_channel_magnitudes(df_chan_stats, df_moco, params$group, params$harmonic, "Pattern", as.numeric(params$p_thresh), plot_titles=params$plot_titles)
```

```{r figX-vector-amplitude-barplots-speed}
plot_channel_magnitudes(df_chan_stats, df_moco, params$group, params$harmonic, "Speed", as.numeric(params$p_thresh), plot_titles=params$plot_titles)
```

```{r figX-vector-amplitude-barplots-pattbyspd}
plot_channel_magnitudes(df_chan_stats, df_moco, params$group, params$harmonic, "Patt_Spd", as.numeric(params$p_thresh), plot_titles=params$plot_titles)
```

### Complex Domain Plots for `r params$n_top` channels with highest amplitudes for `r params$harmonic` in `r init_cap(params$group)` participants

```{r figX-complex-domain-plots-pattern}
plot_complex_domain_results(df_chan_stats, df_moco, "Pattern", params$group, params$harmonic, as.numeric(params$n_top), as.numeric(params$p_thresh), plot_titles=params$plot_titles)
```

```{r figX-complex-domain-plots-speed}
plot_complex_domain_results(df_chan_stats, df_moco, "Speed", params$group, params$harmonic, as.numeric(params$n_top), as.numeric(params$p_thresh), plot_titles=params$plot_titles)
```

```{r figX-complex-domain-plots-pattern-pattbyspd}
plot_complex_domain_results(df_chan_stats, df_moco, "Patt_Spd", params$group, params$harmonic, as.numeric(params$n_top), as.numeric(params$p_thresh), plot_titles=params$plot_titles)
```

### Compute MANOVA effect sizes

```{r generalized-eta-squared-from-univariate, echo=FALSE, include=FALSE}
# Use ezANOVA to compute individual generalized eta squares for Sr, Si, then report mean of the two
ges_list <- lapply(unique(df_moco$Channel), compute_generalized_eta_squared, df=df_moco, harm=params$harmonic)
ges_mat <- matrix(unlist(ges_list), ncol=3, byrow = TRUE)
df_chan_stats$ges = c(ges_mat[1:128,1],ges_mat[1:128,2], ges_mat[1:128,3])
```

### Summary of channel-wise MANOVA statistics

```{r compute-partial-eta-squared-from-F, echo=FALSE}
# More appropriate is to compute the multivariate partial eta squared directly from the approximate F
df_chan_stats <- compute_partial_eta_squared_from_F(df_chan_stats)

# Write MANOVA stats to file
out.fn <- paste("csv/", params$group, "-", 
                  params$harmonic, 
                  "-MANOVA.csv", sep="")
write.csv(x = df_chan_stats, file = out.fn, row.names = FALSE)

# Print stats to screen
df_below <- df_chan_stats %>%
  filter(Pvals <= as.numeric(params$p_thresh)) 

if (dim(df_below)[1] > 0) kable(df_below)
```

There are `r length(unique(df_below$Chan))` channels below threshold.

### Channels with significant T2Circ AND significant MANOVA results

```{r report-overlap-between-t2circ-manova}
T2Circ.chans.below <- unique(df_t2circ_below_thresh$Chan)
df_both <- df_chan_stats %>% 
  filter(Chan %in% T2Circ.chans.below) %>% 
  filter(Pvals <= as.numeric(params$p_thresh))

if (dim(df_both)[1] > 0) kable(df_both)
```

There are `r length(unique(df_both$Chan))` channels below threshold for both measures.
