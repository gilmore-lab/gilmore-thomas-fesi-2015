---
title: "gilmore-thomas-fesi-2015-all-stats.Rmd"
author: "rogilmore"
date: "`r Sys.time()`"
output: html_document
params:
  group: child
  harmonic: 1F1
  p_thresh: .0005
  dpi: 72
  plot_dev: png
  n_top: 9
  plot_titles: TRUE
---

## Analysis of `r params$group` group results at `r params$harmonic`

### Initialize

```{r set-up-paths}
data_path <- 'csv/'
figs_path <- 'figs/'
R_path <- 'R/'

moco_fn <- paste("moco-3-pattern-", params$group, ".csv", sep="")
egi_fn <- "egi.csv"

moco_path <- paste(data_path, moco_fn, sep="")
egi_path <- paste(data_path, egi_fn, sep="")
topoplot_fullpath <- paste(figs_path, "topoplot.png", sep="")
```

```{r source-R-scripts}
# Source R scripts.
file.sources <- list.files(path="R", pattern="*.R$", full.names = TRUE)
sapply(file.sources, source, .GlobalEnv)
```

```{r libraries, warning=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)
library(png)
library(gridExtra)
library(tidyr)
library(knitr)
library(DescTools)
library(heplots) # for etasq()
library(ez)
library(Cairo)

path2figs <- paste('figs', params$harmonic, params$group, "", sep="/")
knitr::opts_chunk$set(dpi=params$dpi, dev=params$plot_dev, fig.path=path2figs, fig.width = 8.5)
```

### Load dataframes

```{r load-data}
df_moco <- read.csv(moco_path)
df_egi <- read.csv(egi_path)
```

### Compute and plot channel-wise effects for `r params$harmonic` for `r init_cap(params$group)` participants.

#### Overall effect at harmonic

Compute mean (Sr, Si) for each participant across conditions, then calculate Hotelling's T2 for the group of measures, and plot.

```{r hotellings-t2-bysubject}
h_t2_list <- lapply(unique(df_moco$Channel), compute_h_t2, df_moco, harm=params$harmonic, bysubject=TRUE)
df_t2btw <- data.frame(Chan <- 1:128, matrix(unlist(h_t2_list), nrow=128, byrow=T))
names(df_t2btw) <- c('Chan', 'T2', 'Pvals', 'df1', 'df2') 
df_t2btw$xpos <- df_egi$xpos
df_t2btw$ypos <- df_egi$ypos

# Cut pvals
pvals_cuts <- c(-.01,.0001, .0005, .001, .005, .01, .05, 1)
pvals_lbls <- c("<.0001","<.0005", "<.001", "<.005", "<.01", "<.05", "ns")

# Create cuts based on p-value levels
Pvals_cuts <- cut( df_t2btw$Pvals, breaks=pvals_cuts, labels=pvals_lbls)
Pvals_cuts <- ordered( Pvals_cuts, levels = rev( pvals_lbls ) )
df_t2btw$Pvals_cuts <- Pvals_cuts
plot_t2_channel_effects(df_t2btw, harm=params$harmonic, group=params$group, "Hotellings T2", topoplot_fullpath, plot_titles=params$plot_titles)
kable(df_t2btw, caption="Hottellings T2 values between participants")
```

Alternatively, we can compute the mean Sr, Si across the sample as a whole. This takes into account the fact that each participant provided 9 data points at each condition, so it should be more sensitive. Also, the weakness of the T2 test in this case, is that if the conditions are distributed in phase, it's possible that the T2 test will fail.

```{r hotellings-t2-across-subjects}
h_t2_list <- lapply(unique(df_moco$Channel), compute_h_t2, df_moco, harm=params$harmonic, bysubject=FALSE)
df_t2acr <- data.frame(Chan <- 1:128, matrix(unlist(h_t2_list), nrow=128, byrow=T))
names(df_t2acr) <- c('Chan', 'T2', 'Pvals', 'df1', 'df2') 
df_t2acr$xpos <- df_egi$xpos
df_t2acr$ypos <- df_egi$ypos

# Cut pvals
pvals_cuts <- c(-.01,.0001, .0005, .001, .005, .01, .05, 1)
pvals_lbls <- c("<.0001","<.0005", "<.001", "<.005", "<.01", "<.05", "ns")

# Create cuts based on p-value levels
Pvals_cuts <- cut( df_t2acr$Pvals, breaks=pvals_cuts, labels=pvals_lbls)
Pvals_cuts <- ordered( Pvals_cuts, levels = rev( pvals_lbls ) )
df_t2acr$Pvals_cuts <- Pvals_cuts

# Topo plot and table
plot_t2_channel_effects(df_t2acr, harm=params$harmonic, group=params$group, "Hotellings T2", topoplot_fullpath, plot_titles=params$plot_titles)
kable(df_t2acr, caption="Hotellings T2 values across participants")
```

Compute mean (Sr, Si) for each participant across conditions, then calculate Victor & Mast's T2circ for the group of measures, and plot.

```{r t2-circ-bysubject}
t2_circ_list <- lapply(unique(df_moco$Channel), compute_t2_circ, df_moco, harm=params$harmonic, bysubject=TRUE)
df_t2cbtw <- data.frame(Chan <- 1:128, matrix(unlist(t2_circ_list), nrow=128, byrow=T))
names(df_t2cbtw) <- c('Chan', 'T2', 'Pvals', 'df1', 'df2') 
df_t2cbtw$xpos <- df_egi$xpos
df_t2cbtw$ypos <- df_egi$ypos

# Cut pvals
pvals_cuts <- c(-.01,.0001, .0005, .001, .005, .01, .05, 1)
pvals_lbls <- c("<.0001","<.0005", "<.001", "<.005", "<.01", "<.05", "ns")

# Create cuts based on p-value levels
Pvals_cuts <- cut( df_t2cbtw$Pvals, breaks=pvals_cuts, labels=pvals_lbls)
Pvals_cuts <- ordered( Pvals_cuts, levels = rev( pvals_lbls ) )
df_t2cbtw$Pvals_cuts <- Pvals_cuts

# Topo plot and table
plot_t2_channel_effects(df_t2cbtw, harm=params$harmonic, group=params$group, "T2circ", topoplot_fullpath, plot_titles=params$plot_titles)
kable(df_t2cbtw, caption="T2circ values between participants")
```

Alternatively, we can compute the mean Sr, Si across the sample as a whole. This takes into account the fact that each participant provided 9 data points at each condition, so it should be more sensitive. Also, the weakness of the T2circ test in this case, is that if the conditions are distributed in phase, it's possible that the T2circ test will fail.

```{r t2-circ-across-subjects}
t2_circ_list <- lapply(unique(df_moco$Channel), compute_t2_circ, df_moco, harm=params$harmonic, bysubject=FALSE)
df_t2cacr <- data.frame(Chan <- 1:128, matrix(unlist(t2_circ_list), nrow=128, byrow=T))
names(df_t2cacr) <- c('Chan', 'T2', 'Pvals', 'df1', 'df2') 
df_t2cacr$xpos <- df_egi$xpos
df_t2cacr$ypos <- df_egi$ypos

# Cut pvals
pvals_cuts <- c(-.01,.0001, .0005, .001, .005, .01, .05, 1)
pvals_lbls <- c("<.0001","<.0005", "<.001", "<.005", "<.01", "<.05", "ns")

# Create cuts based on p-value levels
Pvals_cuts <- cut( df_t2cacr$Pvals, breaks=pvals_cuts, labels=pvals_lbls)
Pvals_cuts <- ordered( Pvals_cuts, levels = rev( pvals_lbls ) )
df_t2cacr$Pvals_cuts <- Pvals_cuts

# Topo plot and table
plot_t2_channel_effects(df_t2cacr, harm=params$harmonic, group=params$group, "T2circ", topoplot_fullpath, plot_titles=params$plot_titles)
kable(df_t2cacr, caption="T2circ values across participants")
```

#### Effects for pattern and speed

```{r channel-wise-effects}
form <- cbind(Sr, Si) ~ Pattern*Speed + Error(iSess)
chan_eff <- compute_chan_effects(df_moco, params$harmonic, form)
df_chan_stats <- make_stats_df(chan_eff, df_egi)
plot_channel_effects(df_chan_stats, harm=params$harmonic, group=params$group, topoplot_fullpath, plot_titles=params$plot_titles)
```

```{r generalized-eta-squared-from-univariate}
# Use ezANOVA to compute individual generalized eta squares for Sr, Si, then report mean of the two
ges_list <- lapply(unique(df_moco$Channel), compute_generalized_eta_squared, df=df_moco, harm=params$harmonic)
ges_mat <- matrix(unlist(ges_list), ncol=3, byrow = TRUE)
df_chan_stats$ges = c(ges_mat[1:128,1],ges_mat[1:128,2], ges_mat[1:128,3])
```

```{r compute-partial-eta-squared-from-F}
# More appropriate is to compute the multivariate partial eta squared directly from the approximate F
df_chan_stats <- compute_partial_eta_squared_from_F(df_chan_stats)
```

### Tables of `r params$harmonic` channel statistics for `r init_cap(params$group)` participants.

```{r combine-hT2-stats}
df_chan_stats$T2btw <- rep( df_t2btw$T2, 3 )
df_chan_stats$T2btw_p <- rep( df_t2btw$Pvals, 3 )
df_chan_stats$T2btw_df1 <- rep( df_t2btw$df1, 3 )
df_chan_stats$T2btw_df2 <- rep( df_t2btw$df2, 3 )

df_chan_stats$T2acr <- rep( df_t2acr$T2, 3 )
df_chan_stats$T2acr_p <- rep( df_t2acr$Pvals, 3 )
df_chan_stats$T2acr_df1 <- rep( df_t2acr$df1, 3 )
df_chan_stats$T2acr_df2 <- rep( df_t2acr$df2, 3 )

df_chan_stats$T2cbtw <- rep( df_t2cbtw$T2, 3 )
df_chan_stats$T2cbtw_p <- rep( df_t2cbtw$Pvals, 3 )
df_chan_stats$T2cbtw_df1 <- rep( df_t2cbtw$df1, 3 )
df_chan_stats$T2cbtw_df2 <- rep( df_t2cbtw$df2, 3 )

df_chan_stats$T2cacr <- rep( df_t2cacr$T2, 3 )
df_chan_stats$T2cacr_p <- rep( df_t2cacr$Pvals, 3 )
df_chan_stats$T2cacr_df1 <- rep( df_t2cacr$df1, 3 )
df_chan_stats$T2cacr_df2 <- rep( df_t2cacr$df2, 3 )
```

```{r print-tables}
print_stats_table(df_chan_stats, "Pattern")
print_stats_table(df_chan_stats, "Speed")
print_stats_table(df_chan_stats, "Patt*Spd")
write.csv(df_chan_stats, file=paste(data_path, 'moco-3-pattern-', params$group, '-', params$harmonic, '-stats.csv', sep=""), row.names=FALSE)
```

### Mean amplitude plots of `r params$harmonic` channels meeting `r paste('p< ', params$p_thresh, sep='')` for `r init_cap(params$group)` participants.

```{r vector-amplitude-barplots-pattern}
plot_channel_magnitudes(df_chan_stats, df_moco, params$group, params$harmonic, "Pattern", as.numeric(params$p_thresh), plot_titles=params$plot_titles)
```

```{r vector-amplitude-barplots-speed}
plot_channel_magnitudes(df_chan_stats, df_moco, params$group, params$harmonic, "Speed", as.numeric(params$p_thresh), plot_titles=params$plot_titles)
```

```{r vector-amplitude-barplots-pattbyspd}
plot_channel_magnitudes(df_chan_stats, df_moco, params$group, params$harmonic, "Patt*Spd", as.numeric(params$p_thresh), plot_titles=params$plot_titles)
```

### Complex Domain Plots for `r params$n_top` channels with highest amplitudes for `r params$harmonic` in `r init_cap(params$group)` participants

```{r complex-domain-plots-pattern}
plot_complex_domain_results(df_chan_stats, df_moco, "Pattern", params$group, params$harmonic, as.numeric(params$n_top), as.numeric(params$p_thresh), plot_titles=params$plot_titles)
```

```{r complex-domain-plots-speed}
plot_complex_domain_results(df_chan_stats, df_moco, "Speed", params$group, params$harmonic, as.numeric(params$n_top), as.numeric(params$p_thresh), plot_titles=params$plot_titles)
```

```{r complex-domain-plots-pattern-pattbyspd}
plot_complex_domain_results(df_chan_stats, df_moco, "Patt*Spd", params$group, params$harmonic, as.numeric(params$n_top), as.numeric(params$p_thresh), plot_titles=params$plot_titles)
```
